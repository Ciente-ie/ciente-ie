<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <title>Ciente - Prontid√£o HRV</title>

    <style>
        :root {
            --app-height: 100vh;
            --vh: 1vh;
            --version: '2.5';
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: #eef1f3;
            margin: 0;
            padding: 10px;
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        h1 {
            font-size: 20px;
            font-weight: 700;
            margin: 5px 0 15px 0;
            color: #1a1a1a;
            text-align: center;
            width: 100%;
            padding: 0;
        }

        #athletes {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 12px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            justify-content: center;
            align-items: stretch;
        }

        .card {
            background: #ffffff;
            border-radius: 10px;
            padding: 12px;
            border: 1px solid #ccc;
            display: flex;
            gap: 12px;
            transition: all 0.2s ease;
            width: calc(50% - 6px);
            max-width: 480px;
            min-width: 300px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            flex-shrink: 0;
            height: fit-content;
        }

        /* LADO ESQUERDO - SUPER COMPACTO */
        .left {
            width: 130px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .left select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 5px;
            border: 1px solid #bbb;
            margin-bottom: 8px;
            font-size: 13px;
            background: white;
            height: 34px;
            font-weight: 500;
        }

        .left button {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 8px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .connect { background: #007bff; color:#fff; }
        .connect.connected { background: #009b2e !important; }
        .start { background: #ff9800; color:white; }
        .start:disabled { background: #c77b00; cursor: not-allowed; opacity: 0.7; }
        .finish { background: #d91b61; color:white; display:none; }

        .status {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            color: #222;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
            line-height: 1.2;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* LADO DIREITO - DADOS E C√çRCULO LADO A LADO */
        .right {
            width: calc(100% - 142px);
            display: flex;
            flex-direction: column;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .live-data {
            flex: 1;
        }

        .live-data p {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .live-data span {
            font-weight: 700;
            font-size: 16px;
            color: #007bff;
        }

        .score-circle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 110px;
        }

        .scoreCircle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            font-size: 26px;
            font-weight: 800;
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            color: #fff;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
            border: 2px solid white;
            margin-bottom: 5px;
        }

        .interp {
            font-size: 12px;
            font-weight: 700;
            visibility: hidden;
            text-align: center;
            line-height: 1.2;
            padding: 5px 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 110px;
        }

        /* ECG animation */
        .pulseRow {
            display: none;
            gap: 4px;
            align-items: flex-end;
            height: 30px;
            justify-content: center;
            margin: 8px 0;
        }

        .pulseBar {
            width: 8px;
            height: 20px;
            background: #ff2b2b;
            animation: pulse 0.7s ease-in-out infinite alternate;
            border-radius: 2px 2px 0 0;
        }

        @keyframes pulse {
            0% { height: 8px; opacity: 0.6; }
            100% { height: 25px; opacity: 1; }
        }

        /* RESULTADOS */
        .results {
            font-size: 12px;
            font-weight: 600;
            visibility: hidden;
            line-height: 1.3;
            text-align: left;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            width: 100%;
            margin-top: 8px;
        }

        /* Hover effects */
        button:hover { filter: brightness(0.92); }
        button:active { transform: scale(0.97); }

        /* MOBILE (at√© 767px) - EMPILHA */
        @media (max-width: 767px) {
            body {
                padding: 8px;
            }
            
            #athletes {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .card {
                width: 100% !important;
                max-width: 95% !important;
                min-width: unset !important;
                flex-direction: column;
                padding: 10px;
            }
            
            .left {
                width: 100% !important;
                margin-bottom: 10px;
            }
            
            .right {
                width: 100% !important;
            }
            
            .data-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .scoreCircle {
                width: 80px;
                height: 80px;
                font-size: 24px;
            }
            
            h1 {
                font-size: 18px;
                margin-bottom: 12px;
            }
        }

        /* TABLET (768px a 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .card {
                width: calc(50% - 6px);
                min-width: 320px;
                padding: 10px;
                gap: 10px;
            }
            
            .left {
                width: 120px;
            }
            
            .right {
                width: calc(100% - 130px);
            }
            
            .scoreCircle {
                width: 85px;
                height: 85px;
                font-size: 24px;
            }
            
            .interp {
                font-size: 11px;
                padding: 4px 6px;
            }
        }

        /* DESKTOP (1025px+) */
        @media (min-width: 1025px) {
            body {
                padding: 15px;
            }
            
            #athletes {
                gap: 15px;
                max-width: 1100px;
            }
            
            .card {
                width: calc(50% - 8px);
                max-width: 500px;
                min-width: 350px;
                padding: 14px;
            }
            
            .left {
                width: 130px;
            }
            
            .right {
                width: calc(100% - 142px);
            }
            
            .scoreCircle {
                width: 95px;
                height: 95px;
                font-size: 28px;
            }
            
            h1 {
                font-size: 22px;
                margin-bottom: 20px;
            }
        }

        /* BOT√ÉO DE LIMPEZA DE CACHE (apenas para debug) */
        .debug-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(108, 117, 125, 0.1);
            color: #666;
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid #ddd;
            font-size: 10px;
            cursor: pointer;
            z-index: 1000;
            display: none;
        }

        /* VERS√ÉO INFO */
        .version-info {
            position: fixed;
            top: 8px;
            right: 8px;
            font-size: 9px;
            color: #999;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 8px;
            z-index: 999;
            border: 1px solid #eee;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="version-info">v2.5</div>
    
    <h1>üè• Ciente - Prontid√£o HRV</h1>
    <div id="athletes"></div>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const APP_VERSION = '2.5';
        const athletesList = ["Atleta 1", "Atleta 2", "Atleta 3", "Atleta 4"];
        const MONITOR_TIME = 60;
        const CALIBRATION = 10;

        let rrData = [];
        let hrData = [];
        let currentIndex = 0;
        let heartChar = null;

        // ===== SERVICE WORKER COM ATUALIZA√á√ÉO AUTOM√ÅTICA =====
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Remove todos os service workers antigos primeiro
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (let registration of registrations) {
                        registration.unregister();
                        console.log('Service Worker antigo removido');
                    }
                    
                    // Aguarda 1s e registra novo
                    setTimeout(() => {
                        navigator.serviceWorker.register('service-worker.js?v=' + APP_VERSION)
                            .then(registration => {
                                console.log('‚úÖ Service Worker registrado:', registration.scope);
                                
                                // For√ßa atualiza√ß√£o imediata
                                registration.update();
                                
                                // Escuta por atualiza√ß√µes
                                registration.addEventListener('updatefound', () => {
                                    const newWorker = registration.installing;
                                    console.log('üîç Nova vers√£o do Service Worker encontrada');
                                    
                                    newWorker.addEventListener('statechange', () => {
                                        if (newWorker.state === 'installed') {
                                            console.log('üì¶ Nova vers√£o instalada');
                                            
                                            // Se j√° tem um service worker ativo, sugere recarregar
                                            if (navigator.serviceWorker.controller) {
                                                if (confirm('Nova vers√£o dispon√≠vel! Recarregar agora?')) {
                                                    window.location.reload();
                                                }
                                            }
                                        }
                                    });
                                });
                            })
                            .catch(error => {
                                console.error('‚ùå Erro ao registrar Service Worker:', error);
                            });
                    }, 1000);
                });
            }
        }

        // ===== VERIFICAR SE √â TABLET =====
        function isTablet() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const isIpad = /iPad/.test(navigator.userAgent);
            const isAndroidTablet = /Android/.test(navigator.userAgent) && width >= 768;
            return (width >= 768 && width <= 1024) || isIpad || isAndroidTablet;
        }

        // ===== CONSTRUIR INTERFACE =====
        function buildUI() {
            const container = document.getElementById("athletes");
            container.innerHTML = '';

            for (let i = 0; i < 2; i++) {
                container.insertAdjacentHTML("beforeend", `
                <div class="card">
                    <div class="left">
                        <select id="athleteSelect${i}">
                            ${athletesList.map(a => `<option>${a}</option>`)}
                        </select>
                        <button id="connect${i}" class="connect">Conectar</button>
                        <button id="start${i}" class="start" disabled>Iniciar</button>
                        <button id="finish${i}" class="finish">Finalizar</button>
                        <p id="status${i}" class="status">Aguardando...</p>
                    </div>
                    <div class="right">
                        <div class="data-row">
                            <div class="live-data">
                                <p><b>FC:</b> <span id="fc${i}">--</span> bpm</p>
                                <p><b>RR:</b> <span id="rr${i}">--</span> ms</p>
                                <div class="pulseRow" id="pulse${i}">
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                </div>
                            </div>
                            <div class="score-circle-container">
                                <div id="circle${i}" class="scoreCircle"></div>
                                <div id="interp${i}" class="interp"></div>
                            </div>
                        </div>
                        <p id="results${i}" class="results"></p>
                    </div>
                </div>`);

                document.getElementById(`connect${i}`).onclick = () => connectPolar(i);
                document.getElementById(`start${i}`).onclick = () => startMonitoring(i);
                document.getElementById(`finish${i}`).onclick = () => resetUI(i);
                
                document.getElementById(`start${i}`).disabled = true;
            }
        }

        // ===== BLUETOOTH =====
        async function connectPolar(i) {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "Polar" }],
                    optionalServices: [0x180D]
                });
                let server = await device.gatt.connect();
                let svc = await server.getPrimaryService(0x180D);
                heartChar = await svc.getCharacteristic(0x2A37);
                await heartChar.startNotifications();
                heartChar.addEventListener("characteristicvaluechanged", parseHR);
                currentIndex = i;

                setStatus(i, "Conectado!");
                document.getElementById(`connect${i}`).classList.add("connected");
                document.getElementById(`connect${i}`).innerHTML = "Conectado";
                document.getElementById(`start${i}`).disabled = false;

            } catch (err) {
                setStatus(i, "Erro ao conectar");
            }
        }

        // ===== PARSE HR =====
        function parseHR(e) {
            const v = e.target.value;
            if (!v) return;
            let flags = v.getUint8(0);
            let hr = (flags & 1) ? v.getUint16(1, true) : v.getUint8(1);
            hrData.push(hr);
            document.getElementById(`fc${currentIndex}`).textContent = hr;
            let pos = (flags & 1) ? 3 : 2;
            if (flags & 0x10) {
                let rr = v.getUint16(pos, true);
                rrData.push(rr);
                document.getElementById(`rr${currentIndex}`).textContent = rr;
            }
        }

        // ===== MONITORAMENTO =====
        function startMonitoring(i) {
            rrData = []; hrData = [];
            currentIndex = i;
            setStatus(i, "Calibrando...");
            document.getElementById(`pulse${i}`).style.display = "flex";
            document.getElementById(`start${i}`).disabled = true;
            document.getElementById(`connect${i}`).disabled = true;

            let t = CALIBRATION + MONITOR_TIME;
            let timer = setInterval(() => {
                t--;
                setStatus(i, t > MONITOR_TIME ? 
                    `Calibrando (${t - MONITOR_TIME}s)` : 
                    `Analisando (${t}s)`);

                if (t <= 0) {
                    clearInterval(timer);
                    if (heartChar) {
                        heartChar.stopNotifications();
                    }
                    finishMonitoring(i);
                }
            }, 1000);
        }

        // ===== C√ÅLCULO lnRMSSD =====
        function calcLnRR(rr) {
            if (rr.length < 3) return 0;
            let diffs = rr.slice(1).map((v, i) => (v - rr[i]) ** 2);
            return +(Math.log(Math.sqrt(diffs.reduce((a, b) => a + b) / diffs.length))).toFixed(2);
        }

        // ===== FINALIZAR TESTE =====
        function finishMonitoring(i) {
            document.getElementById(`pulse${i}`).style.display = "none";

            let ln = calcLnRR(rrData);
            let meanRR = rrData.length > 0 ? Math.round(rrData.reduce((a, b) => a + b, 0) / rrData.length) : 0;
            let meanHR = hrData.length > 0 ? Math.round(hrData.reduce((a, b) => a + b, 0) / hrData.length) : 0;

            document.getElementById(`fc${i}`).textContent = meanHR;
            document.getElementById(`rr${i}`).textContent = meanRR;

            // C√ÅLCULO DO SCORE
            let score;
            if (ln < 3.0) {
                score = 10 + ((ln - 2.0) * 20);
            } 
            else if (ln < 4.0) {
                score = 30 + ((ln - 3.0) * 25);
            } 
            else if (ln < 5.0) {
                score = 55 + ((ln - 4.0) * 20);
            } 
            else if (ln < 6.0) {
                score = 75 + ((ln - 5.0) * 15);
            } 
            else {
                score = 90 + Math.min((ln - 6.0) * 5, 5);
            }

            score = Math.round(Math.max(10, Math.min(score, 95)));

            let circle = document.getElementById(`circle${i}`);
            let interp = document.getElementById(`interp${i}`);
            let results = document.getElementById(`results${i}`);

            results.innerHTML = `lnRMSSD: ${ln}<br>RR M√©dio: ${meanRR} ms`;
            results.style.visibility = circle.style.visibility = interp.style.visibility = "visible";

            // LEGENDAS
            let interpretation = "";
            let color = "";

            if (score <= 30) {
                interpretation = "‚ö†Ô∏è Rec. Muito Baixa";
                color = "#d60000";
            } 
            else if (score <= 55) {
                interpretation = "üî∂ Rec. Baixa";
                color = "#ff7f00";
            } 
            else if (score <= 75) {
                interpretation = "üü° Rec. Moderada";
                color = "#ffcc00";
            } 
            else if (score <= 90) {
                interpretation = "‚úÖ Rec. Boa";
                color = "#87c440";
            } 
            else {
                interpretation = "üèÜ Rec. Excelente";
                color = "#008f14";
            }

            circle.style.background = color;
            interp.textContent = interpretation;
            circle.textContent = score;

            saveCSV(i);
            document.getElementById(`finish${i}`).style.display = "block";
            document.getElementById(`connect${i}`).disabled = false;
            setStatus(i, "Conclu√≠do!");
        }

        // ===== SALVAR CSV =====
        function saveCSV(i) {
            if (rrData.length < 3) return;
            let athlete = document.getElementById(`athleteSelect${i}`).value;
            let csv = "RR\n" + rrData.join("\n");
            let a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
            a.download = `${athlete}_HRV_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ===== RESET UI =====
        function resetUI(i) {
            rrData = []; hrData = [];
            document.getElementById(`pulse${i}`).style.display = "none";
            document.getElementById(`circle${i}`).style.visibility = "hidden";
            document.getElementById(`interp${i}`).style.visibility = "hidden";
            document.getElementById(`results${i}`).style.visibility = "hidden";
            document.getElementById(`start${i}`).disabled = false;
            document.getElementById(`finish${i}`).style.display = "none";
            document.getElementById(`connect${i}`).disabled = false;
            document.getElementById(`fc${i}`).textContent = "--";
            document.getElementById(`rr${i}`).textContent = "--";
            setStatus(i, "Aguardando...");
        }

        // ===== SET STATUS =====
        function setStatus(i, m) {
            document.getElementById(`status${i}`).textContent = m;
        }

        // ===== LIMPAR CACHE MANUAL (para debug) =====
        function clearCacheManual() {
            if (confirm('Limpar todo o cache do app? Isso ir√° recarregar a p√°gina.')) {
                localStorage.clear();
                sessionStorage.clear();
                
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(regs => {
                        regs.forEach(reg => reg.unregister());
                        caches.keys().then(keys => {
                            keys.forEach(key => caches.delete(key));
                            setTimeout(() => window.location.reload(true), 1000);
                        });
                    });
                }
            }
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log(`üöÄ Iniciando Ciente HRV v${APP_VERSION}`);
            
            // Salva vers√£o atual
            localStorage.setItem('app_version', APP_VERSION);
            
            buildUI();
            setupServiceWorker();
            
            // Se for tablet, mostra instru√ß√µes
            if (isTablet()) {
                console.log('üì± Dispositivo detectado como Tablet');
                
                // Instru√ß√µes para instalar no tablet
                setTimeout(() => {
                    if (!window.matchMedia('(display-mode: standalone)').matches) {
                        console.log('PWA n√£o instalado - mostrando dica');
                        
                        // Dica discreta ap√≥s 10 segundos
                        setTimeout(() => {
                            const installTip = document.createElement('div');
                            installTip.innerHTML = `
                                <div style="
                                    position: fixed;
                                    bottom: 60px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    background: #007bff;
                                    color: white;
                                    padding: 10px 15px;
                                    border-radius: 20px;
                                    font-size: 14px;
                                    z-index: 999;
                                    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
                                    text-align: center;
                                    max-width: 300px;
                                ">
                                    üí° Para instalar: Toque em ‚ãÆ ‚Üí "Adicionar √† tela inicial"
                                </div>
                            `;
                            document.body.appendChild(installTip);
                            
                            // Remove ap√≥s 15 segundos
                            setTimeout(() => {
                                if (installTip.parentNode) {
                                    installTip.parentNode.removeChild(installTip);
                                }
                            }, 15000);
                        }, 10000);
                    }
                }, 2000);
            }
            
            // Bot√£o debug (apenas em desenvolvimento)
            if (window.location.hostname.includes('github.io') || window.location.hostname.includes('localhost')) {
                const debugBtn = document.createElement('button');
                debugBtn.className = 'debug-btn';
                debugBtn.innerHTML = 'üîÑ Limpar Cache';
                debugBtn.title = 'Limpar cache manualmente';
                debugBtn.onclick = clearCacheManual;
                document.body.appendChild(debugBtn);
                debugBtn.style.display = 'block';
            }
        });
    </script>
</body>
</html>
