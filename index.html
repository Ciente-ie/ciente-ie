<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#007bff">
    
    <!-- Meta tags para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Prontid√£o HRV">
    
    <link rel="manifest" href="manifest.json">
    <title>Ciente - Prontid√£o HRV</title>

    <style>
        :root {
            --app-height: 100vh;
            --vh: 1vh;
            --version: '3.1'; <!-- CORRIGIDO -->
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: #eef1f3;
            margin: 0;
            padding: 10px;
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        h1 {
            font-size: 20px;
            font-weight: 700;
            margin: 5px 0 15px 0;
            color: #1a1a1a;
            text-align: center;
            width: 100%;
            padding: 0;
        }

        #athletes {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 12px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            justify-content: center;
            align-items: stretch;
        }

        .card {
            background: #ffffff;
            border-radius: 10px;
            padding: 12px;
            border: 1px solid #ccc;
            display: flex;
            gap: 12px;
            transition: all 0.2s ease;
            width: calc(50% - 6px);
            max-width: 480px;
            min-width: 300px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            flex-shrink: 0;
            height: fit-content;
            min-height: 220px;
        }

        /* LADO ESQUERDO - SUPER COMPACTO */
        .left {
            width: 130px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .left select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 5px;
            border: 1px solid #bbb;
            margin-bottom: 8px;
            font-size: 13px;
            background: white;
            height: 34px;
            font-weight: 500;
        }

        .left button {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 8px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .connect { background: #007bff; color:#fff; }
        .connect.connected { background: #009b2e !important; }
        .start { background: #ff9800; color:white; }
        .start:disabled { background: #c77b00; cursor: not-allowed; opacity: 0.7; }
        .finish { background: #d91b61; color:white; display:none; }

        .status {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            color: #222;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
            line-height: 1.2;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* LADO DIREITO - DADOS E C√çRCULO LADO A LADO */
        .right {
            width: calc(100% - 142px);
            display: flex;
            flex-direction: column;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
            min-height: 110px;
        }

        .live-data {
            flex: 1;
        }

        .live-data p {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
        }

        .live-data span {
            font-weight: 700;
            font-size: 16px;
            color: #007bff;
        }

        /* RESULTADOS M√çNIMOS (apenas quando termina automaticamente) */
        .results-mini {
            font-size: 11px;
            font-weight: 600;
            visibility: hidden;
            line-height: 1.2;
            text-align: left;
            padding: 6px 8px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 5px;
            border-left: 3px solid #007bff;
            max-width: 150px;
        }

        /* C√çRCULO DE SCORE */
        .score-circle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 110px;
            max-width: 110px;
        }

        .scoreCircle {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: 800;
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            color: #fff;
            box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
            border: 2px solid white;
            margin-bottom: 5px;
        }

        .interp {
            font-size: 11px;
            font-weight: 700;
            visibility: hidden;
            text-align: center;
            line-height: 1.2;
            padding: 4px 6px;
            border-radius: 5px;
            background: rgba(255,255,255,0.95);
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 110px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* ECG animation */
        .pulseRow {
            display: none;
            gap: 4px;
            align-items: flex-end;
            height: 30px;
            justify-content: center;
            margin: 8px 0;
        }

        .pulseBar {
            width: 8px;
            height: 20px;
            background: #ff2b2b;
            animation: pulse 0.7s ease-in-out infinite alternate;
            border-radius: 2px 2px 0 0;
        }

        @keyframes pulse {
            0% { height: 8px; opacity: 0.6; }
            100% { height: 25px; opacity: 1; }
        }

        /* RESULTADOS COMPLETOS */
        .results-full {
            font-size: 12px;
            font-weight: 600;
            line-height: 1.3;
            text-align: left;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            width: 100%;
            margin-top: 8px;
            display: none;
        }

        /* Hover effects */
        button:hover { filter: brightness(0.92); }
        button:active { transform: scale(0.97); }

        /* MOBILE (at√© 767px) - EMPILHA */
        @media (max-width: 767px) {
            body {
                padding: 8px;
            }
            
            #athletes {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .card {
                width: 100% !important;
                max-width: 95% !important;
                min-width: unset !important;
                flex-direction: column;
                padding: 10px;
                min-height: auto;
            }
            
            .left {
                width: 100% !important;
                margin-bottom: 10px;
            }
            
            .right {
                width: 100% !important;
            }
            
            .data-row {
                flex-direction: column;
                gap: 10px;
                min-height: auto;
            }
            
            .scoreCircle {
                width: 80px;
                height: 80px;
                font-size: 22px;
            }
            
            h1 {
                font-size: 18px;
                margin-bottom: 12px;
            }
        }

        /* TABLET (768px a 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .card {
                width: calc(50% - 6px);
                min-width: 320px;
                padding: 10px;
                gap: 10px;
                min-height: 210px;
            }
            
            .left {
                width: 120px;
            }
            
            .right {
                width: calc(100% - 130px);
            }
            
            .scoreCircle {
                width: 80px;
                height: 80px;
                font-size: 22px;
            }
            
            .interp {
                font-size: 10px;
                padding: 3px 5px;
            }
        }

        /* DESKTOP (1025px+) */
        @media (min-width: 1025px) {
            body {
                padding: 15px;
            }
            
            #athletes {
                gap: 15px;
                max-width: 1100px;
            }
            
            .card {
                width: calc(50% - 8px);
                max-width: 500px;
                min-width: 350px;
                padding: 14px;
                min-height: 230px;
            }
            
            .left {
                width: 130px;
            }
            
            .right {
                width: calc(100% - 142px);
            }
            
            .scoreCircle {
                width: 90px;
                height: 90px;
                font-size: 26px;
            }
            
            h1 {
                font-size: 22px;
                margin-bottom: 20px;
            }
        }

        /* VERS√ÉO INFO */
        .version-info {
            position: fixed;
            top: 8px;
            right: 8px;
            font-size: 9px;
            color: #999;
            background: rgba(255,255,255,0.9);
            padding: 2px 6px;
            border-radius: 8px;
            z-index: 999;
            border: 1px solid #eee;
            font-family: monospace;
        }
        
        /* BOT√ÉO ATUALIZAR APP */
        .update-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            font-size: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="version-info">v3.1</div> <!-- CORRIGIDO -->
    
    <h1>üè• Ciente - Prontid√£o HRV</h1>
    <div id="athletes"></div>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const APP_VERSION = '3.1';
        const athletesList = [
            "ARTHUR LOPES DE NASCIMENTO",
            "CALEBE CARVALHO CANTARELLA",
            "CAIO JARDIM FRATONI",
            "DIOGO DA SILVA GON√áALVES",
            "EDUARDO BRITO DE CASTRO",
            "EMERSON DOS SANTOS JUNIOR",
            "ERICK MAGNO SILVA FIGUEIRA",
            "FELIPE DE PAULA PADERNA",
            "GABRIEL CARVALHO PANISSET",
            "GABRIEL DE MATTOS BRASILEIRO MARTINS",
            "GABRIEL HENRIQUE MENEZES",
            "GABRIEL MONTEIRO DOS REIS",
            "GUILHERME LUCAS",
            "HEITOR MENDES PANTALE√ÉO",
            "HENRIQUE MILLANI DOS SANTOS ANDRADE",
            "HIAN LE√ÉO BOLOGNA",
            "JESS√â BRESCHI DE SOUSA",
            "JO√ÉO ANT√îNIO NOGUEIRA LEAL",
            "JO√ÉO HENRIQUE LOPES CARVALHO",
            "JO√ÉO HENRIQUE MALDONADO LEITE MACHADO",
            "KAU√É HENRIQUE FERREIRA DA SILVA",
            "LUAN MILLER DE MATOS",
            "LUCAS NUNES DA SILVA",
            "LUCAS VIN√çCIUS FERREIRA DA SILVA",
            "LUIS FELIPE DA PENHA MATOS",
            "LUIZ FELIPE MANZATO BATISTA",
            "MANOEL MATHUES ALVES DE SOUZA",
            "MARCOS DE JESUS NEVES",
            "MATHEUS HENRIQUE DOS SANTOS ARAUJO",
            "MATHEUS HENRIQUE GALVIN",
            "PEDRO DE OLIVEIRA MARIA",
            "RAFAEL SEVERINO GON√áALVES MASSON",
            "RYAN NUNES SEVERIANO",
            "SAMUEL SIM√ïES LOPES",
            "THIAGO MATHEUS DE OLIVEIRA PAVELSKI",
            "THIAGO SILVA DOS SANTOS",
            "WENDEL BELTR√ÉO TEN√ìRIO",
            "YGOR GOMES DA CONCEI√á√ÉO"
        ];
        const MONITOR_TIME = 60;
        const CALIBRATION = 10;

        // Vari√°veis para 4 atletas
        let monitoringData = [];
        for (let i = 0; i < 4; i++) {  <!-- MUDADO PARA 4 -->
            monitoringData.push({
                rrData: [],
                hrData: [],
                heartChar: null,
                timer: null,
                isMonitoring: false,
                timeRemaining: 0,
                isConnected: false,  <!-- ADICIONADO -->
                lastHR: null,       <!-- ADICIONADO -->
                lastRR: null        <!-- ADICIONADO -->
            });
        }

        // ===== DETECTAR ATUALIZA√á√ïES DO SERVICE WORKER =====
        function checkForUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.update();
                });
            }
        }

        // ===== SERVICE WORKER =====
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js?v=' + APP_VERSION + '&t=' + Date.now())
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado');
                        
                        // Adiciona bot√£o de atualiza√ß√£o
                        if (registration.waiting) {
                            showUpdateButton();
                        }
                        
                        // Monitora atualiza√ß√µes
                        registration.addEventListener('updatefound', () => {
                            console.log('üîÑ Nova vers√£o encontrada');
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        showUpdateButton();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Erro Service Worker:', error);
                    });
            }
        }

        function showUpdateButton() {
            const existingBtn = document.querySelector('.update-btn');
            if (existingBtn) return;
            
            const updateBtn = document.createElement('button');
            updateBtn.className = 'update-btn';
            updateBtn.innerHTML = 'üîÑ Atualizar App';
            updateBtn.onclick = () => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            window.location.reload();
                        }
                    });
                }
            };
            document.body.appendChild(updateBtn);
        }

        // ===== CONSTRUIR INTERFACE =====
        function buildUI() {
            const container = document.getElementById("athletes");
            container.innerHTML = '';

            for (let i = 0; i < 4; i++) {  <!-- MUDADO PARA 4 -->
                container.insertAdjacentHTML("beforeend", `
                <div class="card">
                    <div class="left">
                        <select id="athleteSelect${i}">
                            <option value="">Selecione um atleta</option>
                            ${athletesList.map(a => `<option>${a}</option>`)}
                        </select>
                        <button id="connect${i}" class="connect">Conectar</button>
                        <button id="start${i}" class="start" disabled>Iniciar</button>
                        <button id="finish${i}" class="finish">Finalizar</button>
                        <p id="status${i}" class="status">Aguardando...</p>
                    </div>
                    <div class="right">
                        <div class="data-row">
                            <div class="live-data">
                                <p><b>FC:</b> <span id="fc${i}">--</span> bpm</p>
                                <p><b>RR:</b> <span id="rr${i}">--</span> ms</p>
                                <div class="pulseRow" id="pulse${i}">
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                </div>
                                <div id="resultsMini${i}" class="results-mini"></div>
                            </div>
                            <div class="score-circle-container">
                                <div id="circle${i}" class="scoreCircle"></div>
                                <div id="interp${i}" class="interp"></div>
                            </div>
                        </div>
                        <div id="resultsFull${i}" class="results-full"></div>
                    </div>
                </div>`);

                document.getElementById(`connect${i}`).onclick = () => connectPolar(i);
                document.getElementById(`start${i}`).onclick = () => startMonitoring(i);
                document.getElementById(`finish${i}`).onclick = () => cancelMonitoring(i);
                
                document.getElementById(`start${i}`).disabled = true;
            }
        }

        // ===== BLUETOOTH =====
        async function connectPolar(i) {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "Polar" }],
                    optionalServices: [0x180D]
                });
                let server = await device.gatt.connect();
                let svc = await server.getPrimaryService(0x180D);
                monitoringData[i].heartChar = await svc.getCharacteristic(0x2A37);
                await monitoringData[i].heartChar.startNotifications();
                
                const currentAthleteIndex = i;
                monitoringData[i].heartChar.addEventListener("characteristicvaluechanged", (e) => parseHR(e, currentAthleteIndex));

                setStatus(i, "Conectado!");
                document.getElementById(`connect${i}`).classList.add("connected");
                document.getElementById(`connect${i}`).innerHTML = "Conectado";
                document.getElementById(`start${i}`).disabled = false;
                monitoringData[i].isConnected = true;

            } catch (err) {
                setStatus(i, "Erro ao conectar");
                monitoringData[i].isConnected = false;
            }
        }

        // ===== PARSE HR =====
        function parseHR(e, i) {
            const v = e.target.value;
            if (!v) return;
            
            let flags = v.getUint8(0);
            let hr = (flags & 1) ? v.getUint16(1, true) : v.getUint8(1);
            
            // Atualiza dados em tempo real IMEDIATAMENTE
            document.getElementById(`fc${i}`).textContent = hr;
            monitoringData[i].lastHR = hr;
            
            // Se estiver monitorando, salva nos arrays
            if (monitoringData[i].isMonitoring) {
                monitoringData[i].hrData.push(hr);
            }
            
            let pos = (flags & 1) ? 3 : 2;
            if (flags & 0x10) {
                let rr = v.getUint16(pos, true);
                
                // Atualiza dados em tempo real IMEDIATAMENTE
                document.getElementById(`rr${i}`).textContent = rr;
                monitoringData[i].lastRR = rr;
                
                // Se estiver monitorando, salva nos arrays
                if (monitoringData[i].isMonitoring) {
                    monitoringData[i].rrData.push(rr);
                }
            }
        }

        // ===== MONITORAMENTO =====
        function startMonitoring(i) {
            // Limpa dados anteriores MAS MANT√âM CONEX√ÉO
            monitoringData[i].rrData = [];
            monitoringData[i].hrData = [];
            monitoringData[i].isMonitoring = true;
            monitoringData[i].timeRemaining = CALIBRATION + MONITOR_TIME;
            
            // Mant√©m os valores atuais vis√≠veis
            if (monitoringData[i].lastHR !== null) {
                document.getElementById(`fc${i}`).textContent = monitoringData[i].lastHR;
            }
            if (monitoringData[i].lastRR !== null) {
                document.getElementById(`rr${i}`).textContent = monitoringData[i].lastRR;
            }
            
            // Atualiza UI
            setStatus(i, "Calibrando...");
            document.getElementById(`pulse${i}`).style.display = "flex";
            document.getElementById(`start${i}`).disabled = true;
            document.getElementById(`connect${i}`).disabled = true;
            document.getElementById(`finish${i}`).style.display = "block";
            
            // Limpa resultados anteriores
            document.getElementById(`circle${i}`).style.visibility = "hidden";
            document.getElementById(`interp${i}`).style.visibility = "hidden";
            document.getElementById(`resultsMini${i}`).style.visibility = "hidden";
            document.getElementById(`resultsFull${i}`).style.display = "none";

            // Limpa timer anterior se existir
            if (monitoringData[i].timer) {
                clearInterval(monitoringData[i].timer);
            }
            
            // Inicia novo timer
            monitoringData[i].timer = setInterval(() => {
                if (!monitoringData[i].isMonitoring) {
                    clearInterval(monitoringData[i].timer);
                    return;
                }
                
                monitoringData[i].timeRemaining--;
                
                setStatus(i, monitoringData[i].timeRemaining > MONITOR_TIME ? 
                    `Calibrando (${monitoringData[i].timeRemaining - MONITOR_TIME}s)` : 
                    `Analisando (${monitoringData[i].timeRemaining}s)`);

                if (monitoringData[i].timeRemaining <= 0) {
                    clearInterval(monitoringData[i].timer);
                    monitoringData[i].isMonitoring = false;
                    finishMonitoring(i);
                }
            }, 1000);
        }

        // ===== CANCELAR MONITORAMENTO =====
        function cancelMonitoring(i) {
            console.log(`Cancelando monitoramento do atleta ${i}`);
            
            // Para tudo mas MANT√âM CONEX√ÉO
            monitoringData[i].isMonitoring = false;
            
            // Para o timer
            if (monitoringData[i].timer) {
                clearInterval(monitoringData[i].timer);
                monitoringData[i].timer = null;
            }
            
            // N√ÉO para as notifica√ß√µes Bluetooth
            // Mant√©m a conex√£o ativa para dados ao vivo
            
            // N√ÉO CALCULA NADA - APENAS LIMPA
            resetUI(i);
            setStatus(i, "Aguardando...");
        }

        // ===== FINALIZAR TESTE AUTOM√ÅTICO =====
        function finishMonitoring(i) {
            console.log(`Finalizando monitoramento autom√°tico do atleta ${i}`);
            
            // Para anima√ß√£o ECG
            document.getElementById(`pulse${i}`).style.display = "none";
            
            // Calcula resultados apenas se tem dados suficientes
            if (monitoringData[i].rrData.length >= 3) {
                calculateAndDisplayResults(i);
            } else {
                // Se n√£o tem dados suficientes, apenas reseta
                resetUI(i);
                setStatus(i, "Dados insuficientes");
            }
        }

        // ===== C√ÅLCULO lnRMSSD =====
        function calcLnRR(rr) {
            if (rr.length < 3) return 0;
            let diffs = rr.slice(1).map((v, i) => (v - rr[i]) ** 2);
            return +(Math.log(Math.sqrt(diffs.reduce((a, b) => a + b) / diffs.length))).toFixed(2);
        }

        // ===== CALCULAR E EXIBIR RESULTADOS =====
        function calculateAndDisplayResults(i) {
            let ln = calcLnRR(monitoringData[i].rrData);
            let meanRR = monitoringData[i].rrData.length > 0 ? 
                Math.round(monitoringData[i].rrData.reduce((a, b) => a + b, 0) / monitoringData[i].rrData.length) : 0;
            let meanHR = monitoringData[i].hrData.length > 0 ? 
                Math.round(monitoringData[i].hrData.reduce((a, b) => a + b, 0) / monitoringData[i].hrData.length) : 0;

            // Mant√©m os dados atuais vis√≠veis
            document.getElementById(`fc${i}`).textContent = monitoringData[i].lastHR || meanHR;
            document.getElementById(`rr${i}`).textContent = monitoringData[i].lastRR || meanRR;

            // C√ÅLCULO DO SCORE
            let score;
            if (ln < 3.0) {
                score = 10 + ((ln - 2.0) * 20);
            } 
            else if (ln < 4.0) {
                score = 30 + ((ln - 3.0) * 25);
            } 
            else if (ln < 5.0) {
                score = 55 + ((ln - 4.0) * 20);
            } 
            else if (ln < 6.0) {
                score = 75 + ((ln - 5.0) * 15);
            } 
            else {
                score = 90 + Math.min((ln - 6.0) * 5, 5);
            }

            score = Math.round(Math.max(10, Math.min(score, 95)));

            let circle = document.getElementById(`circle${i}`);
            let interp = document.getElementById(`interp${i}`);
            let resultsMini = document.getElementById(`resultsMini${i}`);
            let resultsFull = document.getElementById(`resultsFull${i}`);

            // Exibe resultados M√çNIMOS
            resultsMini.innerHTML = `ln: ${ln}<br>RR: ${meanRR}ms`;
            resultsMini.style.visibility = "visible";
            
            // Exibe resultados COMPLETOS
            resultsFull.innerHTML = `<b>Resultados completos:</b><br>lnRMSSD: ${ln}<br>RR M√©dio: ${meanRR} ms<br>FC M√©dia: ${meanHR} bpm<br>Pontua√ß√£o: ${score}/95`;
            resultsFull.style.display = "block";

            // Mostra c√≠rculo e interpreta√ß√£o
            circle.style.visibility = interp.style.visibility = "visible";

            // LEGENDAS
            let interpretation = "";
            let color = "";

            if (score <= 30) {
                interpretation = "‚ö†Ô∏è Rec. Muito Baixa";
                color = "#d60000";
            } 
            else if (score <= 55) {
                interpretation = "üî∂ Rec. Baixa";
                color = "#ff7f00";
            } 
            else if (score <= 75) {
                interpretation = "üü° Rec. Moderada";
                color = "#ffcc00";
            } 
            else if (score <= 90) {
                interpretation = "‚úÖ Rec. Boa";
                color = "#87c440";
            } 
            else {
                interpretation = "üèÜ Rec. Excelente";
                color = "#008f14";
            }

            circle.style.background = color;
            interp.textContent = interpretation;
            circle.textContent = score;

            saveCSV(i);
            document.getElementById(`connect${i}`).disabled = false;
            setStatus(i, "Conclu√≠do!");
        }

        // ===== SALVAR CSV =====
        function saveCSV(i) {
            if (monitoringData[i].rrData.length < 3) return;
            let athlete = document.getElementById(`athleteSelect${i}`).value;
            let csv = "RR\n" + monitoringData[i].rrData.join("\n");
            let a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
            a.download = `${athlete}_HRV_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ===== RESET UI =====
        function resetUI(i) {
            // Limpa arrays de monitoramento MAS MANT√âM √öLTIMOS VALORES
            monitoringData[i].rrData = [];
            monitoringData[i].hrData = [];
            monitoringData[i].isMonitoring = false;
            
            // Para timer
            if (monitoringData[i].timer) {
                clearInterval(monitoringData[i].timer);
                monitoringData[i].timer = null;
            }
            
            // N√£o reseta os valores vis√≠veis se estiver conectado
            document.getElementById(`pulse${i}`).style.display = "none";
            document.getElementById(`circle${i}`).style.visibility = "hidden";
            document.getElementById(`interp${i}`).style.visibility = "hidden";
            document.getElementById(`resultsMini${i}`).style.visibility = "hidden";
            document.getElementById(`resultsFull${i}`).style.display = "none";
            
            // Ativa bot√µes
            document.getElementById(`start${i}`).disabled = !monitoringData[i].isConnected;
            document.getElementById(`finish${i}`).style.display = "none";
            document.getElementById(`connect${i}`).disabled = false;
            
            // S√≥ mostra "--" se n√£o estiver conectado
            if (!monitoringData[i].isConnected) {
                document.getElementById(`fc${i}`).textContent = "--";
                document.getElementById(`rr${i}`).textContent = "--";
            } else {
                // Se conectado, mant√©m os √∫ltimos valores
                if (monitoringData[i].lastHR !== null) {
                    document.getElementById(`fc${i}`).textContent = monitoringData[i].lastHR;
                }
                if (monitoringData[i].lastRR !== null) {
                    document.getElementById(`rr${i}`).textContent = monitoringData[i].lastRR;
                }
            }
        }

        // ===== SET STATUS =====
        function setStatus(i, m) {
            document.getElementById(`status${i}`).textContent = m;
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log(`üöÄ Iniciando Ciente HRV v${APP_VERSION} - 4 Atletas`);
            
            buildUI();
            setupServiceWorker();
            
            // Verificar atualiza√ß√µes periodicamente
            setInterval(checkForUpdates, 60 * 60 * 1000); // A cada hora
            
            // Verificar na inicializa√ß√£o
            setTimeout(checkForUpdates, 5000);
        });
    </script>
</body>
</html>
