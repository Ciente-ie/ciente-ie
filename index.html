<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <title>Ciente - Prontid√£o HRV</title>

    <style>
        :root {
            --app-height: 100vh;
            --vh: 1vh;
            --version: '2.3';
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: #eef1f3;
            margin: 0;
            padding: 15px;
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 20px 0;
            color: #1a1a1a;
            text-align: center;
            width: 100%;
            padding: 0;
        }

        #athletes {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            justify-content: center;
            align-items: flex-start;
        }

        .card {
            background: #ffffff;
            border-radius: 12px;
            padding: 18px;
            border: 1px solid #ddd;
            display: flex;
            gap: 20px;
            transition: all 0.3s ease;
            width: calc(50% - 10px);
            max-width: 580px;
            min-width: 380px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-shrink: 0;
            height: fit-content;
        }

        /* LADO ESQUERDO COMPACTO */
        .left {
            width: 180px; /* FIXO E COMPACTO */
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .left select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 12px;
            font-size: 14px;
            background: white;
            height: 38px;
        }

        .left button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .connect { background: #007bff; color:#fff; }
        .connect.connected { background: #009b2e !important; }
        .start { background: #ff9800; color:white; }
        .start:disabled { background: #c77b00; cursor: not-allowed; opacity: 0.7; }
        .finish { background: #d91b61; color:white; display:none; }

        .status {
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
            color: #222;
            min-height: 20px;
            padding: 6px 8px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }

        /* LADO DIREITO - DADOS E C√çRCULO NA MESMA LINHA */
        .right {
            width: calc(100% - 200px);
            display: flex;
            flex-direction: column;
        }

        .right-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 15px;
        }

        .live-data {
            flex: 1;
            min-width: 150px;
        }

        .live-data p {
            margin: 0 0 8px 0;
            font-size: 15px;
            font-weight: 600;
        }

        .live-data span {
            font-weight: 700;
            font-size: 18px;
            color: #007bff;
        }

        .pulseRow {
            display: none;
            gap: 5px;
            align-items: flex-end;
            height: 40px;
            justify-content: center;
            margin: 10px 0;
        }

        .pulseBar {
            width: 10px;
            height: 25px;
            background: #ff2b2b;
            animation: pulse 0.7s ease-in-out infinite alternate;
            border-radius: 3px 3px 0 0;
        }

        @keyframes pulse {
            0% { height: 12px; opacity: 0.6; }
            100% { height: 40px; opacity: 1; }
        }

        /* C√çRCULO DE SCORE */
        .score-circle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 140px;
        }

        .scoreCircle {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            font-size: 32px;
            font-weight: 800;
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            color: #fff;
            box-shadow: 0px 6px 15px rgba(0,0,0,0.1);
            transition: all 0.4s ease;
            border: 3px solid white;
            margin-bottom: 8px;
        }

        .interp {
            font-size: 14px;
            font-weight: 700;
            visibility: hidden;
            text-align: center;
            line-height: 1.2;
            padding: 6px 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* RESULTADOS (abaixo) */
        .results {
            font-size: 13px;
            font-weight: 600;
            visibility: hidden;
            line-height: 1.4;
            text-align: left;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            width: 100%;
            margin-top: 10px;
        }

        /* Hover effects */
        button:hover { filter: brightness(0.92); }
        button:active { transform: scale(0.97); }

        /* MOBILE (at√© 767px) */
        @media (max-width: 767px) {
            body {
                padding: 10px;
            }
            
            #athletes {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            
            .card {
                width: 100% !important;
                max-width: 100% !important;
                min-width: unset !important;
                flex-direction: column;
                padding: 15px;
                margin-bottom: 0;
            }
            
            .left {
                width: 100% !important;
                margin-bottom: 15px;
            }
            
            .right {
                width: 100% !important;
            }
            
            .right-top {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .live-data {
                width: 100%;
                text-align: center;
            }
            
            .scoreCircle {
                width: 100px;
                height: 100px;
                font-size: 28px;
            }
            
            h1 {
                font-size: 22px;
                margin-bottom: 15px;
            }
        }

        /* TABLET (768px a 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .card {
                width: calc(50% - 10px);
                min-width: 350px;
                padding: 15px;
                gap: 15px;
            }
            
            .left {
                width: 160px;
            }
            
            .right {
                width: calc(100% - 175px);
            }
            
            .scoreCircle {
                width: 100px;
                height: 100px;
                font-size: 30px;
            }
            
            .interp {
                font-size: 13px;
                padding: 5px 8px;
            }
        }

        /* DESKTOP (1025px+) */
        @media (min-width: 1025px) {
            body {
                padding: 20px;
            }
            
            #athletes {
                gap: 25px;
                max-width: 1300px;
            }
            
            .card {
                width: calc(50% - 12px);
                max-width: 600px;
                min-width: 400px;
                padding: 20px;
            }
            
            .left {
                width: 180px;
            }
            
            .right {
                width: calc(100% - 200px);
            }
            
            .scoreCircle {
                width: 120px;
                height: 120px;
                font-size: 34px;
            }
            
            h1 {
                font-size: 26px;
                margin-bottom: 25px;
            }
        }

        /* LANDSCAPE ESPEC√çFICO */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 12px;
                gap: 12px;
                min-width: 350px;
            }
            
            .scoreCircle {
                width: 90px;
                height: 90px;
                font-size: 26px;
            }
            
            button, select {
                min-height: 36px;
                padding: 8px;
                font-size: 13px;
            }
        }

        /* BOT√ÉO DE ATUALIZA√á√ÉO (ESCONDIDO POR PADR√ÉO) */
        .update-button {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: #6c757d;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            border: none;
            font-size: 11px;
            cursor: pointer;
            z-index: 1000;
            opacity: 0.7;
            display: none;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .update-button:hover {
            opacity: 1;
            background: #5a6268;
        }

        /* TOAST DE ATUALIZA√á√ÉO */
        .update-toast {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: #17a2b8;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
            font-size: 14px;
        }

        @keyframes slideDown {
            from { top: -50px; opacity: 0; }
            to { top: 15px; opacity: 1; }
        }

        /* VERS√ÉO INFO */
        .version-info {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 10px;
            color: #888;
            background: rgba(255,255,255,0.9);
            padding: 3px 8px;
            border-radius: 10px;
            z-index: 999;
            border: 1px solid #eee;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="version-info">v2.3</div>
    <div class="update-toast" id="updateToast">
        <span>üîÑ Nova vers√£o!</span>
        <button onclick="window.location.reload()" style="background:white;color:#17a2b8;border:none;padding:3px 10px;border-radius:10px;font-weight:bold;cursor:pointer;font-size:12px;">
            Atualizar
        </button>
    </div>
    
    <h1>üè• Ciente - Prontid√£o HRV</h1>
    <div id="athletes"></div>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const APP_VERSION = '2.3';
        const athletesList = ["Atleta 1", "Atleta 2", "Atleta 3", "Atleta 4"];
        const MONITOR_TIME = 60;
        const CALIBRATION = 10;

        let rrData = [];
        let hrData = [];
        let currentIndex = 0;
        let heartChar = null;

        // ===== VERIFICAR ATUALIZA√á√ïES =====
        async function checkForUpdates() {
            try {
                const response = await fetch(`./index.html?v=${Date.now()}`);
                const text = await response.text();
                const versionMatch = text.match(/const APP_VERSION = ['"]([^'"]+)['"]/);
                const serverVersion = versionMatch ? versionMatch[1] : '1.0';
                const localVersion = localStorage.getItem('app_version') || APP_VERSION;
                
                if (serverVersion !== localVersion) {
                    const toast = document.getElementById('updateToast');
                    toast.style.display = 'flex';
                    
                    setTimeout(() => {
                        if (toast.style.display === 'flex') {
                            toast.style.opacity = '0';
                            setTimeout(() => {
                                toast.style.display = 'none';
                                toast.style.opacity = '1';
                            }, 500);
                        }
                    }, 10000);
                    
                    return true;
                }
                return false;
            } catch (error) {
                return false;
            }
        }

        // ===== ATUALIZA√á√ÉO AUTOM√ÅTICA =====
        function setupAutoUpdate() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js?v=' + APP_VERSION)
                    .then(registration => {
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000);
                        
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    checkForUpdates();
                                }
                            });
                        });
                    });
                
                if (window.location.search.includes('forceUpdate=1')) {
                    navigator.serviceWorker.getRegistrations().then(regs => {
                        regs.forEach(reg => reg.unregister());
                        caches.keys().then(keys => {
                            keys.forEach(key => caches.delete(key));
                            setTimeout(() => window.location.reload(), 1000);
                        });
                    });
                }
            }
        }

        // ===== AJUSTE DE LAYOUT =====
        function adjustLayout() {
            const width = window.innerWidth;
            const athletesContainer = document.getElementById('athletes');
            const cards = document.querySelectorAll('.card');
            
            if (!athletesContainer || cards.length === 0) return;
            
            if (width <= 767) {
                athletesContainer.style.flexDirection = 'column';
                athletesContainer.style.alignItems = 'center';
                
                cards.forEach(card => {
                    card.style.width = '100%';
                    card.style.flexDirection = 'column';
                });
            } else {
                athletesContainer.style.flexDirection = 'row';
                athletesContainer.style.flexWrap = 'wrap';
                athletesContainer.style.justifyContent = 'center';
                
                const cardWidth = width < 1024 ? 'calc(50% - 10px)' : 'calc(50% - 12px)';
                
                cards.forEach(card => {
                    card.style.width = cardWidth;
                    card.style.flexDirection = 'row';
                });
            }
        }

        // ===== CONSTRUIR INTERFACE =====
        function buildUI() {
            const container = document.getElementById("athletes");
            container.innerHTML = '';

            for (let i = 0; i < 2; i++) {
                container.insertAdjacentHTML("beforeend", `
                <div class="card">
                    <div class="left">
                        <select id="athleteSelect${i}">
                            ${athletesList.map(a => `<option>${a}</option>`)}
                        </select>
                        <button id="connect${i}" class="connect">Conectar</button>
                        <button id="start${i}" class="start" disabled>Iniciar</button>
                        <button id="finish${i}" class="finish">Finalizar</button>
                        <p id="status${i}" class="status">Aguardando...</p>
                    </div>
                    <div class="right">
                        <div class="right-top">
                            <div class="live-data">
                                <p><b>FC:</b> <span id="fc${i}">--</span> bpm</p>
                                <p><b>RR:</b> <span id="rr${i}">--</span> ms</p>
                                <div class="pulseRow" id="pulse${i}">
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                    <div class="pulseBar"></div>
                                </div>
                            </div>
                            <div class="score-circle-container">
                                <div id="circle${i}" class="scoreCircle"></div>
                                <div id="interp${i}" class="interp"></div>
                            </div>
                        </div>
                        <p id="results${i}" class="results"></p>
                    </div>
                </div>`);

                document.getElementById(`connect${i}`).onclick = () => connectPolar(i);
                document.getElementById(`start${i}`).onclick = () => startMonitoring(i);
                document.getElementById(`finish${i}`).onclick = () => resetUI(i);
                
                document.getElementById(`start${i}`).disabled = true;
            }
            
            adjustLayout();
        }

        // ===== BLUETOOTH =====
        async function connectPolar(i) {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "Polar" }],
                    optionalServices: [0x180D]
                });
                let server = await device.gatt.connect();
                let svc = await server.getPrimaryService(0x180D);
                heartChar = await svc.getCharacteristic(0x2A37);
                await heartChar.startNotifications();
                heartChar.addEventListener("characteristicvaluechanged", parseHR);
                currentIndex = i;

                setStatus(i, "Conectado!");
                document.getElementById(`connect${i}`).classList.add("connected");
                document.getElementById(`connect${i}`).innerHTML = "Conectado";
                document.getElementById(`start${i}`).disabled = false;

            } catch (err) {
                setStatus(i, "Erro ao conectar");
            }
        }

        // ===== PARSE HR =====
        function parseHR(e) {
            const v = e.target.value;
            if (!v) return;
            let flags = v.getUint8(0);
            let hr = (flags & 1) ? v.getUint16(1, true) : v.getUint8(1);
            hrData.push(hr);
            document.getElementById(`fc${currentIndex}`).textContent = hr;
            let pos = (flags & 1) ? 3 : 2;
            if (flags & 0x10) {
                let rr = v.getUint16(pos, true);
                rrData.push(rr);
                document.getElementById(`rr${currentIndex}`).textContent = rr;
            }
        }

        // ===== MONITORAMENTO =====
        function startMonitoring(i) {
            rrData = []; hrData = [];
            currentIndex = i;
            setStatus(i, "Calibrando...");
            document.getElementById(`pulse${i}`).style.display = "flex";
            document.getElementById(`start${i}`).disabled = true;
            document.getElementById(`connect${i}`).disabled = true;

            let t = CALIBRATION + MONITOR_TIME;
            let timer = setInterval(() => {
                t--;
                setStatus(i, t > MONITOR_TIME ? 
                    `Calibrando... (${t - MONITOR_TIME}s)` : 
                    `Analisando... (${t}s)`);

                if (t <= 0) {
                    clearInterval(timer);
                    if (heartChar) {
                        heartChar.stopNotifications();
                    }
                    finishMonitoring(i);
                }
            }, 1000);
        }

        // ===== C√ÅLCULO lnRMSSD =====
        function calcLnRR(rr) {
            if (rr.length < 3) return 0;
            let diffs = rr.slice(1).map((v, i) => (v - rr[i]) ** 2);
            return +(Math.log(Math.sqrt(diffs.reduce((a, b) => a + b) / diffs.length))).toFixed(2);
        }

        // ===== FINALIZAR TESTE =====
        function finishMonitoring(i) {
            document.getElementById(`pulse${i}`).style.display = "none";

            let ln = calcLnRR(rrData);
            let meanRR = rrData.length > 0 ? Math.round(rrData.reduce((a, b) => a + b, 0) / rrData.length) : 0;
            let meanHR = hrData.length > 0 ? Math.round(hrData.reduce((a, b) => a + b, 0) / hrData.length) : 0;

            document.getElementById(`fc${i}`).textContent = meanHR;
            document.getElementById(`rr${i}`).textContent = meanRR;

            // C√ÅLCULO DO SCORE
            let score;
            if (ln < 3.0) {
                score = 10 + ((ln - 2.0) * 20);
            } 
            else if (ln < 4.0) {
                score = 30 + ((ln - 3.0) * 25);
            } 
            else if (ln < 5.0) {
                score = 55 + ((ln - 4.0) * 20);
            } 
            else if (ln < 6.0) {
                score = 75 + ((ln - 5.0) * 15);
            } 
            else {
                score = 90 + Math.min((ln - 6.0) * 5, 5);
            }

            score = Math.round(Math.max(10, Math.min(score, 95)));

            let circle = document.getElementById(`circle${i}`);
            let interp = document.getElementById(`interp${i}`);
            let results = document.getElementById(`results${i}`);

            results.innerHTML = `lnRMSSD: ${ln}<br>RR M√©dio: ${meanRR} ms`;
            results.style.visibility = circle.style.visibility = interp.style.visibility = "visible";

            // NOVAS LEGENDAS
            let interpretation = "";
            let color = "";

            if (score <= 30) {
                interpretation = "‚ö†Ô∏è Recupera√ß√£o Muito Baixa";
                color = "#d60000";
            } 
            else if (score <= 55) {
                interpretation = "üî∂ Recupera√ß√£o Baixa";
                color = "#ff7f00";
            } 
            else if (score <= 75) {
                interpretation = "üü° Recupera√ß√£o Moderada";
                color = "#ffcc00";
            } 
            else if (score <= 90) {
                interpretation = "‚úÖ Recupera√ß√£o Boa";
                color = "#87c440";
            } 
            else {
                interpretation = "üèÜ Recupera√ß√£o Excelente";
                color = "#008f14";
            }

            circle.style.background = color;
            interp.textContent = interpretation;
            circle.textContent = score;

            saveCSV(i);
            document.getElementById(`finish${i}`).style.display = "block";
            document.getElementById(`connect${i}`).disabled = false;
            setStatus(i, "Conclu√≠do!");
        }

        // ===== SALVAR CSV =====
        function saveCSV(i) {
            if (rrData.length < 3) return;
            let athlete = document.getElementById(`athleteSelect${i}`).value;
            let csv = "RR\n" + rrData.join("\n");
            let a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
            a.download = `${athlete}_HRV_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ===== RESET UI =====
        function resetUI(i) {
            rrData = []; hrData = [];
            document.getElementById(`pulse${i}`).style.display = "none";
            document.getElementById(`circle${i}`).style.visibility = "hidden";
            document.getElementById(`interp${i}`).style.visibility = "hidden";
            document.getElementById(`results${i}`).style.visibility = "hidden";
            document.getElementById(`start${i}`).disabled = false;
            document.getElementById(`finish${i}`).style.display = "none";
            document.getElementById(`connect${i}`).disabled = false;
            document.getElementById(`fc${i}`).textContent = "--";
            document.getElementById(`rr${i}`).textContent = "--";
            setStatus(i, "Aguardando...");
        }

        // ===== SET STATUS =====
        function setStatus(i, m) {
            document.getElementById(`status${i}`).textContent = m;
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', () => {
            const savedVersion = localStorage.getItem('app_version');
            if (savedVersion !== APP_VERSION) {
                localStorage.setItem('app_version', APP_VERSION);
            }
            
            buildUI();
            setupAutoUpdate();
            
            setTimeout(checkForUpdates, 10000);
            setInterval(checkForUpdates, 5 * 60 * 1000);
            
            window.addEventListener('resize', adjustLayout);
            window.addEventListener('orientationchange', () => {
                setTimeout(adjustLayout, 300);
            });
            
            // Bot√£o de atualiza√ß√£o apenas em desktop
            if (window.innerWidth > 1024) {
                const updateBtn = document.createElement('button');
                updateBtn.className = 'update-button';
                updateBtn.innerHTML = 'üîÑ';
                updateBtn.title = 'For√ßar atualiza√ß√£o';
                updateBtn.onclick = () => {
                    if (confirm('Recarregar para verificar atualiza√ß√µes?')) {
                        window.location.reload();
                    }
                };
                document.body.appendChild(updateBtn);
                updateBtn.style.display = 'flex';
            }
        });
    </script>
</body>
</html>
