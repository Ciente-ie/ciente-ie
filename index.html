<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <title>Ciente - Prontid√£o HRV</title>

    <style>
        :root {
            --app-height: 100vh;
            --vh: 1vh;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: #eef1f3;
            margin: 0;
            padding: 20px;
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-x: hidden;
        }

        body.tablet-mode {
            height: calc(var(--app-height, 100vh) - 40px);
            min-height: calc(var(--app-height, 100vh) - 40px);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #1a1a1a;
            text-align: center;
            width: 100%;
        }

        .card {
            background: #ffffff;
            width: 100%;
            max-width: 950px;
            border-radius: 16px;
            padding: 22px 28px;
            border: 2px solid #dedede;
            margin: 0 auto 25px;
            display: flex;
            justify-content: space-between;
            gap: 32px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0px 4px 12px rgba(0,0,0,0.08);
        }

        .left {
            width: 32%;
            display: flex;
            flex-direction: column;
        }

        .right {
            width: 63%;
            border-left: 2px solid #e2e2e2;
            padding-left: 26px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        select {
            width: fit-content;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 12px;
            font-size: 15px;
            background: white;
            min-height: 44px;
        }

        button {
            width: 170px;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            margin-bottom: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .connect { background: #007bff; color:#fff; }
        .connect.connected { background: #009b2e !important; }

        .start { background: #ff9800; color:white; }
        .start:disabled { background: #c77b00; cursor: default; opacity: 0.7; }

        .finish { background: #d91b61; color:white; display:none; }
        .finish:hover { background: #c61356; }

        .status {
            font-size: 17px;
            font-weight: bold;
            margin-top: 12px;
            color: #222;
            min-height: 24px;
        }

        /* ECG animation */
        .pulseRow {
            display: none;
            gap: 6px;
            align-items: flex-end;
            height: 50px;
            justify-content: center;
        }

        .pulseBar {
            width: 11px;
            height: 30px;
            background: #ff2b2b;
            animation: pulse 0.65s ease-in-out infinite alternate;
            border-radius: 4px 4px 0 0;
        }
        @keyframes pulse {
            from { height: 18px; opacity: 0.65; }
            to { height: 55px; opacity: 1; }
        }

        /* SCORE */
        .scoreSection {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .scoreData {
            font-size: 17px;
            font-weight: 600;
            line-height: 1.5;
        }

        .scoreContainer {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .scoreCircle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            font-size: 44px;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            color: #fff;
            box-shadow: 0px 0px 25px rgba(0,0,0,0.12);
            transition: all 0.3s ease;
        }

        .interp {
            font-size: 19px;
            font-weight: 700;
            visibility: hidden;
            text-align: left;
            max-width: 200px;
            line-height: 1.3;
        }

        .results {
            font-size: 15px;
            font-weight: 600;
            margin-top: 14px;
            visibility: hidden;
            line-height: 1.4;
        }

        /* Hover effects */
        button:hover { filter: brightness(0.95); }
        button:active { transform: scale(0.98); }

        /* Tablet (768px a 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            body {
                padding: 15px;
                justify-content: flex-start;
            }
            
            .card {
                max-width: 95%;
                flex-direction: row;
                gap: 25px;
                padding: 20px;
                margin: 20px auto;
            }
            
            .left, .right {
                width: 48%;
            }
            
            button {
                padding: 14px;
                font-size: 16px;
                min-height: 50px;
                width: 100%;
                max-width: 200px;
            }
            
            select {
                font-size: 16px;
                padding: 10px;
                width: 100%;
                max-width: 200px;
            }
            
            .scoreCircle {
                width: 140px;
                height: 140px;
                font-size: 40px;
            }
        }

        /* Tablets grandes (1025px a 1366px) */
        @media (min-width: 1025px) and (max-width: 1366px) {
            .card {
                max-width: 1100px;
                margin: 30px auto;
                padding: 25px 30px;
            }
            
            .scoreCircle {
                width: 160px;
                height: 160px;
                font-size: 42px;
            }
            
            h1 {
                font-size: 32px;
                margin-bottom: 30px;
            }
        }

        /* Mobile (at√© 767px) */
        @media (max-width: 767px) {
            body {
                padding: 15px 10px;
                min-height: -webkit-fill-available;
            }
            
            .card {
                flex-direction: column;
                gap: 20px;
                padding: 15px;
                margin-bottom: 20px;
                max-width: 100%;
            }
            
            .left, .right {
                width: 100%;
                border-left: none;
                border-top: 2px solid #e2e2e2;
                padding-left: 0;
                padding-top: 20px;
            }
            
            .left {
                border-top: none;
                padding-top: 0;
            }
            
            .scoreSection {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 15px;
            }
            
            .scoreContainer {
                flex-direction: column;
                gap: 15px;
                margin-top: 10px;
            }
            
            .scoreCircle {
                width: 130px;
                height: 130px;
                font-size: 38px;
            }
            
            .pulseRow {
                justify-content: center;
                margin: 15px 0;
            }
            
            select, button {
                width: 100%;
                max-width: 280px;
                margin-left: auto;
                margin-right: auto;
            }
            
            button {
                min-height: 50px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
        }

        /* Orienta√ß√£o landscape em mobile */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 12px 16px;
                gap: 15px;
                margin-bottom: 15px;
            }
            
            h1 {
                font-size: 22px;
                margin-bottom: 15px;
            }
            
            .scoreCircle {
                width: 100px;
                height: 100px;
                font-size: 32px;
            }
            
            button {
                width: 140px;
                padding: 10px;
                font-size: 14px;
                min-height: 44px;
            }
            
            select {
                padding: 6px;
                font-size: 14px;
                min-height: 40px;
            }
        }

        /* Desktop grande */
        @media (min-width: 1367px) {
            body {
                padding: 30px;
            }
            
            .card {
                max-width: 1200px;
                padding: 30px 35px;
                margin: 25px auto;
            }
            
            .scoreCircle {
                width: 170px;
                height: 170px;
                font-size: 48px;
            }
            
            h1 {
                font-size: 36px;
                margin-bottom: 35px;
            }
        }

        /* Corre√ß√£o para iOS Safari */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
        }

        /* Dispositivos touch */
        @media (hover: none) and (pointer: coarse) {
            button:active {
                transform: scale(0.96);
            }
            
            select {
                font-size: 16px;
            }
        }

        /* Vers√£o info */
        .version-info {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #666;
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="version-info">v2.1</div>
    <h1>üè• Ciente - Prontid√£o HRV</h1>
    <div id="athletes"></div>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const athletesList = ["Atleta 1", "Atleta 2", "Atleta 3", "Atleta 4"];
        const MONITOR_TIME = 60;
        const CALIBRATION = 10;

        let rrData = [];
        let hrData = [];
        let currentIndex = 0;
        let heartChar = null;

        // ===== DETEC√á√ÉO DE DISPOSITIVO =====
        function isTablet() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const isIpad = /iPad/.test(navigator.userAgent);
            const isAndroidTablet = /Android/.test(navigator.userAgent) && width >= 768;
            return (width >= 768 && width <= 1024) || isIpad || isAndroidTablet;
        }

        // ===== CORRE√á√ïES PARA TABLET =====
        function applyTabletFixes() {
            if (!isTablet()) return;
            
            console.log('Aplicando corre√ß√µes para tablet...');
            document.body.classList.add('tablet-mode');
            
            // Destrava orienta√ß√£o
            if (screen.orientation && screen.orientation.unlock) {
                screen.orientation.unlock().catch(() => {
                    console.log('Orienta√ß√£o j√° destravada');
                });
            }
            
            // Ajusta altura
            const appHeight = () => {
                const doc = document.documentElement;
                doc.style.setProperty('--app-height', `${window.innerHeight}px`);
            };
            window.addEventListener('resize', appHeight);
            appHeight();
        }

        // ===== CONSTRUIR INTERFACE =====
        function buildUI() {
            const container = document.getElementById("athletes");

            for (let i = 0; i < 2; i++) {
                container.insertAdjacentHTML("beforeend", `
                <div class="card">
                    <div class="left">
                        <select id="athleteSelect${i}">
                            ${athletesList.map(a => `<option>${a}</option>`)}
                        </select>
                        <button id="connect${i}" class="connect">üì∂ Conectar</button>
                        <button id="start${i}" class="start">‚ñ∂Ô∏è Iniciar</button>
                        <button id="finish${i}" class="finish">‚èπÔ∏è Finalizar</button>
                        <p id="status${i}" class="status">Aguardando conex√£o...</p>
                    </div>
                    <div class="right">
                        <div class="scoreSection">
                            <div class="scoreData">
                                <p><b>FC:</b> <span id="fc${i}">--</span> bpm</p>
                                <p><b>RR:</b> <span id="rr${i}">--</span> ms</p>
                            </div>
                            <div class="pulseRow" id="pulse${i}">
                                <div class="pulseBar"></div>
                                <div class="pulseBar"></div>
                                <div class="pulseBar"></div>
                                <div class="pulseBar"></div>
                                <div class="pulseBar"></div>
                            </div>
                            <div class="scoreContainer">
                                <div id="circle${i}" class="scoreCircle"></div>
                                <div id="interp${i}" class="interp"></div>
                            </div>
                        </div>
                        <p id="results${i}" class="results"></p>
                    </div>
                </div>`);

                document.getElementById(`connect${i}`).onclick = () => connectPolar(i);
                document.getElementById(`start${i}`).onclick = () => startMonitoring(i);
                document.getElementById(`finish${i}`).onclick = () => resetUI(i);
                
                // Inicialmente desabilita iniciar
                document.getElementById(`start${i}`).disabled = true;
            }
        }

        // ===== BLUETOOTH =====
        async function connectPolar(i) {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "Polar" }],
                    optionalServices: [0x180D]
                });
                let server = await device.gatt.connect();
                let svc = await server.getPrimaryService(0x180D);
                heartChar = await svc.getCharacteristic(0x2A37);
                await heartChar.startNotifications();
                heartChar.addEventListener("characteristicvaluechanged", parseHR);
                currentIndex = i;

                setStatus(i, "‚úÖ Conectado!");
                document.getElementById(`connect${i}`).classList.add("connected");
                document.getElementById(`connect${i}`).innerHTML = "‚úÖ Conectado";
                document.getElementById(`start${i}`).disabled = false;

            } catch (err) {
                setStatus(i, "‚ùå Erro ao conectar");
                console.error("Erro Bluetooth:", err);
            }
        }

        // ===== PARSE HR =====
        function parseHR(e) {
            const v = e.target.value;
            if (!v) return;
            let flags = v.getUint8(0);
            let hr = (flags & 1) ? v.getUint16(1, true) : v.getUint8(1);
            hrData.push(hr);
            document.getElementById(`fc${currentIndex}`).textContent = hr;
            let pos = (flags & 1) ? 3 : 2;
            if (flags & 0x10) {
                let rr = v.getUint16(pos, true);
                rrData.push(rr);
                document.getElementById(`rr${currentIndex}`).textContent = rr;
            }
        }

        // ===== MONITORAMENTO =====
        function startMonitoring(i) {
            rrData = []; hrData = [];
            currentIndex = i;
            setStatus(i, "üîß Calibrando...");
            document.getElementById(`pulse${i}`).style.display = "flex";
            document.getElementById(`start${i}`).disabled = true;
            document.getElementById(`connect${i}`).disabled = true;

            let t = CALIBRATION + MONITOR_TIME;
            let timer = setInterval(() => {
                t--;
                setStatus(i, t > MONITOR_TIME ? 
                    `üîß Calibrando... (${t - MONITOR_TIME}s)` : 
                    `üìä Analisando... (${t}s)`);

                if (t <= 0) {
                    clearInterval(timer);
                    if (heartChar) {
                        heartChar.stopNotifications();
                    }
                    finishMonitoring(i);
                }
            }, 1000);
        }

        // ===== C√ÅLCULO lnRMSSD =====
        function calcLnRR(rr) {
            if (rr.length < 3) return 0;
            let diffs = rr.slice(1).map((v, i) => (v - rr[i]) ** 2);
            return +(Math.log(Math.sqrt(diffs.reduce((a, b) => a + b) / diffs.length))).toFixed(2);
        }

        // ===== FINALIZAR TESTE - C√ÅLCULO REVISADO =====
        function finishMonitoring(i) {
            document.getElementById(`pulse${i}`).style.display = "none";

            let ln = calcLnRR(rrData);
            let meanRR = rrData.length > 0 ? Math.round(rrData.reduce((a, b) => a + b, 0) / rrData.length) : 0;
            let meanHR = hrData.length > 0 ? Math.round(hrData.reduce((a, b) => a + b, 0) / hrData.length) : 0;

            document.getElementById(`fc${i}`).textContent = meanHR;
            document.getElementById(`rr${i}`).textContent = meanRR;

            // ===== NOVO C√ÅLCULO REVISADO =====
            let score;
            if (ln < 3.0) {
                score = 10 + ((ln - 2.0) * 20);
            } 
            else if (ln < 4.0) {
                score = 30 + ((ln - 3.0) * 25);
            } 
            else if (ln < 5.0) {
                score = 55 + ((ln - 4.0) * 20);
            } 
            else if (ln < 6.0) {
                score = 75 + ((ln - 5.0) * 15);
            } 
            else {
                score = 90 + Math.min((ln - 6.0) * 5, 5);
            }

            score = Math.round(Math.max(10, Math.min(score, 95)));

            let circle = document.getElementById(`circle${i}`);
            let interp = document.getElementById(`interp${i}`);
            let results = document.getElementById(`results${i}`);

            // Exibir resultados
            results.innerHTML = `lnRMSSD: ${ln}<br>RR M√©dio: ${meanRR} ms`;
            results.style.visibility = circle.style.visibility = interp.style.visibility = "visible";

            // ===== NOVAS INTERPRETA√á√ïES =====
            let interpretation = "";
            let color = "";

            if (score <= 30) {
                interpretation = "‚ö†Ô∏è ALERTA: Descansar";
                color = "#d60000";
            } 
            else if (score <= 55) {
                interpretation = "üî∂ Treino Leve";
                color = "#ff7f00";
            } 
            else if (score <= 75) {
                interpretation = "üü° Treino Normal";
                color = "#ffcc00";
            } 
            else if (score <= 90) {
                interpretation = "‚úÖ Bom - Treino Intenso";
                color = "#87c440";
            } 
            else {
                interpretation = "üèÜ Excelente - Pronto para Competir";
                color = "#008f14";
            }

            circle.style.background = color;
            interp.textContent = interpretation;
            circle.textContent = score;

            saveCSV(i);
            document.getElementById(`finish${i}`).style.display = "block";
            document.getElementById(`connect${i}`).disabled = false;
            setStatus(i, "‚úÖ Conclu√≠do!");
        }

        // ===== SALVAR CSV =====
        function saveCSV(i) {
            if (rrData.length < 3) return;
            let athlete = document.getElementById(`athleteSelect${i}`).value;
            let csv = "RR\n" + rrData.join("\n");
            let a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
            a.download = `${athlete}_HRV_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ===== RESET UI =====
        function resetUI(i) {
            rrData = []; hrData = [];
            document.getElementById(`pulse${i}`).style.display = "none";
            document.getElementById(`circle${i}`).style.visibility = "hidden";
            document.getElementById(`interp${i}`).style.visibility = "hidden";
            document.getElementById(`results${i}`).style.visibility = "hidden";
            document.getElementById(`start${i}`).disabled = false;
            document.getElementById(`finish${i}`).style.display = "none";
            document.getElementById(`connect${i}`).disabled = false;
            document.getElementById(`fc${i}`).textContent = "--";
            document.getElementById(`rr${i}`).textContent = "--";
            setStatus(i, "Aguardando...");
        }

        // ===== SET STATUS =====
        function setStatus(i, m) {
            document.getElementById(`status${i}`).textContent = m;
        }

        // ===== BOT√ÉO INSTALA√á√ÉO DESKTOP =====
        function setupInstallButton() {
            let deferredPrompt;
            const installBtn = document.createElement('button');
            installBtn.innerHTML = 'üì¶ Instalar no PC';
            installBtn.id = 'installBtn';
            installBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #007bff;
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                border: none;
                font-size: 14px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0,123,255,0.3);
                z-index: 9999;
                display: none;
                align-items: center;
                gap: 8px;
                transition: all 0.3s ease;
            `;
            document.body.appendChild(installBtn);

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'flex';
                
                installBtn.onclick = async () => {
                    installBtn.style.display = 'none';
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Usu√°rio ${outcome} a instala√ß√£o`);
                    deferredPrompt = null;
                };
            });

            window.addEventListener('appinstalled', () => {
                installBtn.style.display = 'none';
            });

            // Esconde ap√≥s 30 segundos
            setTimeout(() => {
                if (installBtn.style.display === 'flex') {
                    installBtn.style.opacity = '0';
                    setTimeout(() => {
                        installBtn.style.display = 'none';
                    }, 500);
                }
            }, 30000);
        }

        // ===== SERVICE WORKER =====
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Limpa service workers antigos
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (let registration of registrations) {
                        registration.unregister();
                    }
                });

                // Registra novo
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js?v=2.1')
                        .then(registration => {
                            console.log('‚úÖ Service Worker registrado:', registration.scope);
                            
                            // Verifica atualiza√ß√µes
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        console.log('Nova vers√£o dispon√≠vel!');
                                        if (confirm('Nova vers√£o dispon√≠vel! Recarregar agora?')) {
                                            window.location.reload();
                                        }
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.log('‚ùå Erro Service Worker:', error);
                        });
                });
            }
        }

        // ===== ORIENTA√á√ÉO CHANGE =====
        function setupOrientationHandler() {
            window.addEventListener('orientationchange', () => {
                console.log('Orienta√ß√£o mudou:', screen.orientation.type);
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 100);
            });
        }

        // ===== BOT√ÉO CORRE√á√ÉO TABLET =====
        function addTabletFixButton() {
            if (!isTablet()) return;
            
            const fixBtn = document.createElement('button');
            fixBtn.innerHTML = 'üîÑ Ajustar Tablet';
            fixBtn.style.cssText = `
                position: fixed;
                bottom: 70px;
                right: 20px;
                background: #ff9800;
                color: white;
                padding: 10px 15px;
                border-radius: 20px;
                border: none;
                font-size: 13px;
                cursor: pointer;
                z-index: 9998;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 6px;
            `;
            
            fixBtn.onclick = function() {
                // Limpa tudo
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(regs => {
                        regs.forEach(reg => reg.unregister());
                        caches.keys().then(keys => {
                            keys.forEach(key => caches.delete(key));
                            localStorage.setItem('tablet_fixed', 'true');
                            window.location.reload(true);
                        });
                    });
                }
            };
            
            document.body.appendChild(fixBtn);
            
            // Remove ap√≥s 45 segundos
            setTimeout(() => {
                fixBtn.style.opacity = '0';
                setTimeout(() => {
                    if (fixBtn.parentNode) {
                        fixBtn.parentNode.removeChild(fixBtn);
                    }
                }, 500);
            }, 45000);
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Iniciando Ciente HRV v2.1...');
            console.log('Dispositivo:', isTablet() ? 'Tablet' : 'Mobile/Desktop');
            console.log('Tela:', window.innerWidth, 'x', window.innerHeight);
            console.log('Orienta√ß√£o:', screen.orientation?.type || 'n√£o dispon√≠vel');
            
            buildUI();
            applyTabletFixes();
            setupServiceWorker();
            setupInstallButton();
            setupOrientationHandler();
            addTabletFixButton();
            
            // Aplica corre√ß√µes se for tablet
            if (isTablet() && !localStorage.getItem('tablet_fixed')) {
                setTimeout(() => {
                    if (confirm('Detectamos que est√° usando um tablet. Aplicar otimiza√ß√µes?')) {
                        localStorage.setItem('tablet_fixed', 'true');
                        window.location.reload();
                    }
                }, 2000);
            }
        });

        // ===== FOR√áAR ATUALIZA√á√ÉO SE PAR√ÇMETRO =====
        if (window.location.search.includes('force=1')) {
            localStorage.clear();
            sessionStorage.clear();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(regs => {
                    regs.forEach(reg => reg.unregister());
                    caches.keys().then(keys => {
                        keys.forEach(key => caches.delete(key));
                    });
                });
            }
        }
    </script>
</body>
</html>
