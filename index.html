<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <title>Ciente - Prontid√£o HRV</title>

    <style>
        :root {
            --app-height: 100vh;
            --vh: 1vh;
            --version: '2.2';
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: #eef1f3;
            margin: 0;
            padding: 20px;
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        body.tablet-mode {
            height: calc(var(--app-height, 100vh) - 40px);
            min-height: calc(var(--app-height, 100vh) - 40px);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #1a1a1a;
            text-align: center;
            width: 100%;
            padding: 0 10px;
        }

        #athletes {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 25px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            justify-content: center;
            align-items: stretch;
        }

        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 22px 28px;
            border: 2px solid #dedede;
            display: flex;
            justify-content: space-between;
            gap: 25px;
            transition: all 0.3s ease;
            width: calc(50% - 15px);
            max-width: 600px;
            min-width: 450px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .card:hover {
            box-shadow: 0px 6px 16px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .left {
            width: 42%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .right {
            width: 58%;
            border-left: 2px solid #e2e2e2;
            padding-left: 25px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
            font-size: 16px;
            background: white;
            min-height: 46px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            cursor: pointer;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 50px;
        }

        .connect { background: #007bff; color:#fff; }
        .connect.connected { background: #009b2e !important; }

        .start { background: #ff9800; color:white; }
        .start:disabled { background: #c77b00; cursor: not-allowed; opacity: 0.7; }

        .finish { background: #d91b61; color:white; display:none; }
        .finish:hover { background: #c61356; }

        .status {
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            color: #222;
            min-height: 24px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        /* ECG animation */
        .pulseRow {
            display: none;
            gap: 6px;
            align-items: flex-end;
            height: 50px;
            justify-content: center;
            margin: 15px 0;
        }

        .pulseBar {
            width: 12px;
            height: 30px;
            background: #ff2b2b;
            animation: pulse 0.7s ease-in-out infinite alternate;
            border-radius: 4px 4px 0 0;
        }
        @keyframes pulse {
            0% { height: 15px; opacity: 0.6; }
            100% { height: 50px; opacity: 1; }
        }

        /* SCORE */
        .scoreSection {
            display: flex;
            flex-direction: column;
            width: 100%;
            align-items: center;
            gap: 15px;
        }

        .scoreData {
            font-size: 17px;
            font-weight: 600;
            line-height: 1.5;
            width: 100%;
            text-align: center;
        }

        .scoreContainer {
            display: flex;
            align-items: center;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }

        .scoreCircle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            font-size: 42px;
            font-weight: 800;
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            color: #fff;
            box-shadow: 0px 8px 25px rgba(0,0,0,0.15);
            transition: all 0.4s ease;
            border: 4px solid white;
        }

        .interp {
            font-size: 18px;
            font-weight: 700;
            visibility: hidden;
            text-align: center;
            max-width: 180px;
            line-height: 1.3;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
        }

        .results {
            font-size: 15px;
            font-weight: 600;
            margin-top: 15px;
            visibility: hidden;
            line-height: 1.4;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            width: 100%;
        }

        /* Hover effects */
        button:hover { filter: brightness(0.92); }
        button:active { transform: scale(0.97); }

        /* Mobile (at√© 767px) */
        @media (max-width: 767px) {
            body {
                padding: 15px 10px;
                min-height: -webkit-fill-available;
            }
            
            #athletes {
                flex-direction: column;
                gap: 20px;
                align-items: center;
            }
            
            .card {
                width: 100% !important;
                max-width: 500px !important;
                min-width: unset !important;
                flex-direction: column;
                padding: 18px;
                margin-bottom: 0;
            }
            
            .left, .right {
                width: 100% !important;
                border-left: none !important;
                border-top: 2px solid #e2e2e2;
                padding-left: 0 !important;
                padding-top: 18px;
            }
            
            .left {
                border-top: none;
                padding-top: 0;
            }
            
            .scoreSection {
                gap: 12px;
            }
            
            .scoreContainer {
                flex-direction: column;
                gap: 15px;
            }
            
            .scoreCircle {
                width: 130px;
                height: 130px;
                font-size: 38px;
            }
            
            .pulseRow {
                margin: 12px 0;
            }
            
            select, button {
                font-size: 16px;
                min-height: 48px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
        }

        /* Tablet pequeno (768px a 900px) */
        @media (min-width: 768px) and (max-width: 900px) {
            .card {
                width: calc(50% - 12px);
                min-width: 350px;
                padding: 18px;
                gap: 20px;
            }
            
            .scoreCircle {
                width: 120px;
                height: 120px;
                font-size: 36px;
            }
            
            .interp {
                font-size: 16px;
                max-width: 150px;
            }
        }

        /* Tablet m√©dio (901px a 1024px) */
        @media (min-width: 901px) and (max-width: 1024px) {
            .card {
                width: calc(50% - 15px);
                min-width: 380px;
            }
        }

        /* Desktop (1025px+) */
        @media (min-width: 1025px) {
            body {
                padding: 25px;
            }
            
            #athletes {
                gap: 30px;
            }
            
            .card {
                width: calc(50% - 15px);
                max-width: 650px;
                min-width: 480px;
                padding: 25px 30px;
            }
            
            .scoreCircle {
                width: 150px;
                height: 150px;
                font-size: 44px;
            }
            
            h1 {
                font-size: 32px;
                margin-bottom: 30px;
            }
        }

        /* Landscape espec√≠fico */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
                gap: 15px;
                min-width: 400px;
            }
            
            .scoreCircle {
                width: 110px;
                height: 110px;
                font-size: 32px;
            }
            
            button, select {
                min-height: 44px;
                padding: 10px;
            }
        }

        /* Corre√ß√£o para iOS Safari */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
            
            select {
                font-size: 16px;
            }
        }

        /* Vers√£o info */
        .version-info {
            position: fixed;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #666;
            background: rgba(255,255,255,0.9);
            padding: 4px 10px;
            border-radius: 12px;
            z-index: 1000;
            border: 1px solid #ddd;
            font-family: monospace;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .version-info::before {
            content: 'üîÑ';
            font-size: 10px;
        }

        /* Bot√£o de atualiza√ß√£o */
        .update-button {
            position: fixed;
            bottom: 70px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            font-size: 13px;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 3px 10px rgba(40,167,69,0.3);
            display: none;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .update-button:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        /* Toast de atualiza√ß√£o */
        .update-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #17a2b8;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { top: -50px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }

        /* Loader de atualiza√ß√£o */
        .update-loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .update-loader::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div class="version-info">v2.2</div>
    <div class="update-toast" id="updateToast">
        <span>üîÑ Nova vers√£o dispon√≠vel!</span>
        <button onclick="window.location.reload()" style="background:white;color:#17a2b8;border:none;padding:4px 12px;border-radius:12px;font-weight:bold;cursor:pointer;">Atualizar</button>
    </div>
    <div class="update-loader" id="updateLoader">
        <div style="font-size:18px;font-weight:bold;color:#007bff;">Atualizando...</div>
    </div>
    
    <h1>üè• Ciente - Prontid√£o HRV</h1>
    <div id="athletes"></div>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const APP_VERSION = '2.2';
        const athletesList = ["Atleta 1", "Atleta 2", "Atleta 3", "Atleta 4"];
        const MONITOR_TIME = 60;
        const CALIBRATION = 10;

        let rrData = [];
        let hrData = [];
        let currentIndex = 0;
        let heartChar = null;

        // ===== VERIFICAR ATUALIZA√á√ïES =====
        async function checkForUpdates() {
            try {
                // Verifica se h√° nova vers√£o no servidor
                const response = await fetch(`./index.html?v=${Date.now()}`);
                const text = await response.text();
                
                // Extrai vers√£o do HTML
                const versionMatch = text.match(/const APP_VERSION = ['"]([^'"]+)['"]/);
                const serverVersion = versionMatch ? versionMatch[1] : '1.0';
                
                // Compara com vers√£o local
                const localVersion = localStorage.getItem('app_version') || APP_VERSION;
                
                if (serverVersion !== localVersion) {
                    console.log(`Nova vers√£o dispon√≠vel: ${serverVersion} (atual: ${localVersion})`);
                    
                    // Mostra toast de atualiza√ß√£o
                    const toast = document.getElementById('updateToast');
                    toast.style.display = 'flex';
                    toast.innerHTML = `
                        <span>üîÑ Nova vers√£o ${serverVersion} dispon√≠vel!</span>
                        <button onclick="applyUpdate()" style="background:white;color:#17a2b8;border:none;padding:4px 12px;border-radius:12px;font-weight:bold;cursor:pointer;margin-left:10px;">
                            Atualizar
                        </button>
                    `;
                    
                    // Auto-esconde ap√≥s 30 segundos
                    setTimeout(() => {
                        if (toast.style.display === 'flex') {
                            toast.style.opacity = '0';
                            setTimeout(() => {
                                toast.style.display = 'none';
                                toast.style.opacity = '1';
                            }, 500);
                        }
                    }, 30000);
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.log('Erro ao verificar atualiza√ß√µes:', error);
                return false;
            }
        }

        // ===== APLICAR ATUALIZA√á√ÉO =====
        function applyUpdate() {
            const loader = document.getElementById('updateLoader');
            loader.style.display = 'flex';
            
            // Limpa caches
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(regs => {
                    regs.forEach(reg => reg.unregister());
                    
                    caches.keys().then(keys => {
                        keys.forEach(key => caches.delete(key));
                        
                        // Limpa localStorage
                        localStorage.clear();
                        sessionStorage.clear();
                        
                        // Salva nova vers√£o
                        localStorage.setItem('app_version', APP_VERSION);
                        localStorage.setItem('last_update', new Date().toISOString());
                        
                        // Recarrega ap√≥s 2 segundos
                        setTimeout(() => {
                            window.location.reload(true);
                        }, 2000);
                    });
                });
            }
        }

        // ===== ATUALIZA√á√ÉO AUTOM√ÅTICA DO SERVICE WORKER =====
        function setupAutoUpdate() {
            if ('serviceWorker' in navigator) {
                // Registra service worker
                navigator.serviceWorker.register('service-worker.js?v=' + APP_VERSION)
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                        
                        // Verifica atualiza√ß√µes periodicamente
                        setInterval(() => {
                            registration.update();
                        }, 5 * 60 * 1000); // A cada 5 minutos
                        
                        // Escuta por nova vers√£o
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('üîç Nova vers√£o do Service Worker encontrada');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üì¶ Nova vers√£o pronta para instala√ß√£o');
                                    
                                    // Mostra notifica√ß√£o
                                    if (Notification.permission === 'granted') {
                                        new Notification('Ciente HRV Atualizado', {
                                            body: 'Nova vers√£o dispon√≠vel! Recarregue para atualizar.',
                                            icon: './icon-192.png'
                                        });
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Erro Service Worker:', error);
                    });
                
                // For√ßa atualiza√ß√£o se solicitado
                if (window.location.search.includes('forceUpdate=1')) {
                    navigator.serviceWorker.getRegistrations().then(regs => {
                        regs.forEach(reg => reg.unregister());
                        caches.keys().then(keys => {
                            keys.forEach(key => caches.delete(key));
                            setTimeout(() => window.location.reload(), 1000);
                        });
                    });
                }
            }
        }

        // ===== AJUSTE DE LAYOUT =====
        function adjustLayout() {
            const width = window.innerWidth;
            const athletesContainer = document.getElementById('athletes');
            const cards = document.querySelectorAll('.card');
            
            if (!athletesContainer || cards.length === 0) return;
            
            // Tablet/Mobile
            if (width <= 767) {
                athletesContainer.style.flexDirection = 'column';
                athletesContainer.style.alignItems = 'center';
                
                cards.forEach(card => {
                    card.style.width = '100%';
                    card.style.maxWidth = '500px';
                    card.style.flexDirection = 'column';
                    
                    const right = card.querySelector('.right');
                    if (right) {
                        right.style.borderLeft = 'none';
                        right.style.borderTop = '2px solid #e2e2e2';
                        right.style.paddingLeft = '0';
                        right.style.paddingTop = '18px';
                        right.style.width = '100%';
                    }
                    
                    const left = card.querySelector('.left');
                    if (left) {
                        left.style.width = '100%';
                    }
                });
            } 
            // Desktop/Tablet Landscape
            else {
                athletesContainer.style.flexDirection = 'row';
                athletesContainer.style.flexWrap = 'wrap';
                athletesContainer.style.justifyContent = 'center';
                
                const cardWidth = width < 1024 ? 'calc(50% - 15px)' : 'calc(50% - 20px)';
                
                cards.forEach(card => {
                    card.style.width = cardWidth;
                    card.style.flexDirection = 'row';
                    
                    const right = card.querySelector('.right');
                    if (right) {
                        right.style.borderLeft = '2px solid #e2e2e2';
                        right.style.borderTop = 'none';
                        right.style.paddingLeft = '25px';
                        right.style.paddingTop = '0';
                        right.style.width = '58%';
                    }
                    
                    const left = card.querySelector('.left');
                    if (left) {
                        left.style.width = '42%';
                    }
                });
            }
        }

        // ===== CONSTRUIR INTERFACE =====
        function buildUI() {
            const container = document.getElementById("athletes");
            container.innerHTML = '';

            for (let i = 0; i < 2; i++) {
                container.insertAdjacentHTML("beforeend", `
                <div class="card">
                    <div class="left">
                        <select id="athleteSelect${i}">
                            ${athletesList.map(a => `<option>${a}</option>`)}
                        </select>
                        <button id="connect${i}" class="connect">üì∂ Conectar</button>
                        <button id="start${i}" class="start" disabled>‚ñ∂Ô∏è Iniciar</button>
                        <button id="finish${i}" class="finish">‚èπÔ∏è Finalizar</button>
                        <p id="status${i}" class="status">Aguardando conex√£o...</p>
                    </div>
                    <div class="right">
                        <div class="scoreSection">
                            <div class="scoreData">
                                <p><b>FC:</b> <span id="fc${i}">--</span> bpm</p>
                                <p><b>RR:</b> <span id="rr${i}">--</span> ms</p>
                            </div>
                            <div class="pulseRow" id="pulse${i}">
                                <div class="pulseBar"></div>
                                <div class="pulseBar"></div>
                                <div class="pulseBar"></div>
                                <div class="pulseBar"></div>
                                <div class="pulseBar"></div>
                            </div>
                            <div class="scoreContainer">
                                <div id="circle${i}" class="scoreCircle"></div>
                                <div id="interp${i}" class="interp"></div>
                            </div>
                        </div>
                        <p id="results${i}" class="results"></p>
                    </div>
                </div>`);

                document.getElementById(`connect${i}`).onclick = () => connectPolar(i);
                document.getElementById(`start${i}`).onclick = () => startMonitoring(i);
                document.getElementById(`finish${i}`).onclick = () => resetUI(i);
                
                document.getElementById(`start${i}`).disabled = true;
            }
            
            adjustLayout();
        }

        // ===== BLUETOOTH =====
        async function connectPolar(i) {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "Polar" }],
                    optionalServices: [0x180D]
                });
                let server = await device.gatt.connect();
                let svc = await server.getPrimaryService(0x180D);
                heartChar = await svc.getCharacteristic(0x2A37);
                await heartChar.startNotifications();
                heartChar.addEventListener("characteristicvaluechanged", parseHR);
                currentIndex = i;

                setStatus(i, "‚úÖ Conectado!");
                document.getElementById(`connect${i}`).classList.add("connected");
                document.getElementById(`connect${i}`).innerHTML = "‚úÖ Conectado";
                document.getElementById(`start${i}`).disabled = false;

            } catch (err) {
                setStatus(i, "‚ùå Erro ao conectar");
                console.error("Erro Bluetooth:", err);
            }
        }

        // ===== PARSE HR =====
        function parseHR(e) {
            const v = e.target.value;
            if (!v) return;
            let flags = v.getUint8(0);
            let hr = (flags & 1) ? v.getUint16(1, true) : v.getUint8(1);
            hrData.push(hr);
            document.getElementById(`fc${currentIndex}`).textContent = hr;
            let pos = (flags & 1) ? 3 : 2;
            if (flags & 0x10) {
                let rr = v.getUint16(pos, true);
                rrData.push(rr);
                document.getElementById(`rr${currentIndex}`).textContent = rr;
            }
        }

        // ===== MONITORAMENTO =====
        function startMonitoring(i) {
            rrData = []; hrData = [];
            currentIndex = i;
            setStatus(i, "üîß Calibrando...");
            document.getElementById(`pulse${i}`).style.display = "flex";
            document.getElementById(`start${i}`).disabled = true;
            document.getElementById(`connect${i}`).disabled = true;

            let t = CALIBRATION + MONITOR_TIME;
            let timer = setInterval(() => {
                t--;
                setStatus(i, t > MONITOR_TIME ? 
                    `üîß Calibrando... (${t - MONITOR_TIME}s)` : 
                    `üìä Analisando... (${t}s)`);

                if (t <= 0) {
                    clearInterval(timer);
                    if (heartChar) {
                        heartChar.stopNotifications();
                    }
                    finishMonitoring(i);
                }
            }, 1000);
        }

        // ===== C√ÅLCULO lnRMSSD =====
        function calcLnRR(rr) {
            if (rr.length < 3) return 0;
            let diffs = rr.slice(1).map((v, i) => (v - rr[i]) ** 2);
            return +(Math.log(Math.sqrt(diffs.reduce((a, b) => a + b) / diffs.length))).toFixed(2);
        }

        // ===== FINALIZAR TESTE - C√ÅLCULO REVISADO =====
        function finishMonitoring(i) {
            document.getElementById(`pulse${i}`).style.display = "none";

            let ln = calcLnRR(rrData);
            let meanRR = rrData.length > 0 ? Math.round(rrData.reduce((a, b) => a + b, 0) / rrData.length) : 0;
            let meanHR = hrData.length > 0 ? Math.round(hrData.reduce((a, b) => a + b, 0) / hrData.length) : 0;

            document.getElementById(`fc${i}`).textContent = meanHR;
            document.getElementById(`rr${i}`).textContent = meanRR;

            // ===== NOVO C√ÅLCULO REVISADO =====
            let score;
            if (ln < 3.0) {
                score = 10 + ((ln - 2.0) * 20);
            } 
            else if (ln < 4.0) {
                score = 30 + ((ln - 3.0) * 25);
            } 
            else if (ln < 5.0) {
                score = 55 + ((ln - 4.0) * 20);
            } 
            else if (ln < 6.0) {
                score = 75 + ((ln - 5.0) * 15);
            } 
            else {
                score = 90 + Math.min((ln - 6.0) * 5, 5);
            }

            score = Math.round(Math.max(10, Math.min(score, 95)));

            let circle = document.getElementById(`circle${i}`);
            let interp = document.getElementById(`interp${i}`);
            let results = document.getElementById(`results${i}`);

            // Exibir resultados
            results.innerHTML = `lnRMSSD: ${ln}<br>RR M√©dio: ${meanRR} ms`;
            results.style.visibility = circle.style.visibility = interp.style.visibility = "visible";

            // ===== NOVAS LEGENDAS CORRIGIDAS =====
            let interpretation = "";
            let color = "";

            if (score <= 30) {
                interpretation = "‚ö†Ô∏è Recupera√ß√£o Muito Baixa";
                color = "#d60000";
            } 
            else if (score <= 55) {
                interpretation = "üî∂ Recupera√ß√£o Baixa";
                color = "#ff7f00";
            } 
            else if (score <= 75) {
                interpretation = "üü° Recupera√ß√£o Moderada";
                color = "#ffcc00";
            } 
            else if (score <= 90) {
                interpretation = "‚úÖ Recupera√ß√£o Boa";
                color = "#87c440";
            } 
            else {
                interpretation = "üèÜ Recupera√ß√£o Excelente";
                color = "#008f14";
            }

            circle.style.background = color;
            interp.textContent = interpretation;
            circle.textContent = score;

            saveCSV(i);
            document.getElementById(`finish${i}`).style.display = "block";
            document.getElementById(`connect${i}`).disabled = false;
            setStatus(i, "‚úÖ Conclu√≠do!");
        }

        // ===== SALVAR CSV =====
        function saveCSV(i) {
            if (rrData.length < 3) return;
            let athlete = document.getElementById(`athleteSelect${i}`).value;
            let csv = "RR\n" + rrData.join("\n");
            let a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
            a.download = `${athlete}_HRV_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ===== RESET UI =====
        function resetUI(i) {
            rrData = []; hrData = [];
            document.getElementById(`pulse${i}`).style.display = "none";
            document.getElementById(`circle${i}`).style.visibility = "hidden";
            document.getElementById(`interp${i}`).style.visibility = "hidden";
            document.getElementById(`results${i}`).style.visibility = "hidden";
            document.getElementById(`start${i}`).disabled = false;
            document.getElementById(`finish${i}`).style.display = "none";
            document.getElementById(`connect${i}`).disabled = false;
            document.getElementById(`fc${i}`).textContent = "--";
            document.getElementById(`rr${i}`).textContent = "--";
            setStatus(i, "Aguardando...");
        }

        // ===== SET STATUS =====
        function setStatus(i, m) {
            document.getElementById(`status${i}`).textContent = m;
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log(`üöÄ Iniciando Ciente HRV v${APP_VERSION}...`);
            
            // Verifica vers√£o salva
            const savedVersion = localStorage.getItem('app_version');
            if (savedVersion !== APP_VERSION) {
                console.log(`üì¶ Atualizando de v${savedVersion || '1.0'} para v${APP_VERSION}`);
                localStorage.setItem('app_version', APP_VERSION);
                localStorage.setItem('last_update', new Date().toISOString());
            }
            
            buildUI();
            setupAutoUpdate();
            
            // Verifica atualiza√ß√µes ap√≥s 10 segundos
            setTimeout(checkForUpdates, 10000);
            
            // Verifica a cada 5 minutos
            setInterval(checkForUpdates, 5 * 60 * 1000);
            
            // Ajusta layout quando redimensionar
            window.addEventListener('resize', adjustLayout);
            window.addEventListener('orientationchange', () => {
                setTimeout(adjustLayout, 300);
            });
            
            // Bot√£o para for√ßar atualiza√ß√£o
            const forceUpdateBtn = document.createElement('button');
            forceUpdateBtn.className = 'update-button';
            forceUpdateBtn.id = 'forceUpdateBtn';
            forceUpdateBtn.innerHTML = 'üîÑ For√ßar Atualiza√ß√£o';
            forceUpdateBtn.onclick = () => {
                if (confirm('For√ßar atualiza√ß√£o do app? Isso ir√° limpar o cache.')) {
                    applyUpdate();
                }
            };
            document.body.appendChild(forceUpdateBtn);
            
            // Mostra bot√£o se for desenvolvimento
            if (window.location.hostname.includes('github.io')) {
                forceUpdateBtn.style.display = 'flex';
            }
            
            // Log para debug
            console.log('User Agent:', navigator.userAgent);
            console.log('Tela:', window.innerWidth, 'x', window.innerHeight);
            console.log('Orienta√ß√£o:', screen.orientation?.type || 'n√£o dispon√≠vel');
        });

        // ===== EXPORT FUNCTIONS =====
        window.applyUpdate = applyUpdate;
    </script>
</body>
</html>
